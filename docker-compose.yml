services:
  # ---------------------------------------------------------------------------
  # CORE SERVICES
  # ---------------------------------------------------------------------------
  authentication-service:
    #container_name: authentication-service
    build:
      context: ./services/authentication-service
      dockerfile: Dockerfile
    environment:
      - PORT=3002
      - JWT_SECRET=${JWT_SECRET}
      - DATABASE_URL=${DATABASE_URL}
    volumes:
      - ./services/authentication-service:/usr/src/app
      - /usr/src/app/node_modules
    deploy:
      restart_policy:
        condition: on-failure
    command: npm run dev
    networks:
      - scams-network
    depends_on:
      - postgres-db

  booking-service:
    #container_name: booking-service
    build:
      context: ./services/booking-service
      dockerfile: Dockerfile
    environment:
      - PORT=3003
      - ROMS_API_URL=http://mock-roms-api:3001
      - DATABASE_URL=${DATABASE_URL}
    volumes:
      - ./services/booking-service:/usr/src/app
      - /usr/src/app/node_modules
    deploy:
      restart_policy:
        condition: on-failure
    command: npm run dev
    networks:
      - scams-network
    depends_on:
      - postgres-db
      - mock-roms-api
  
  scheduler-service:
    #container_name: scheduler-service
    build:
      context: ./services/scheduler-service
      dockerfile: Dockerfile
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - RABBITMQ_URL=${RABBITMQ_URL}
    volumes:
      - ./services/scheduler-service:/usr/src/app
      - /usr/src/app/node_modules
    deploy:
      restart_policy:
        condition: on-failure
    command: npm run dev
    networks:
      - scams-network
    depends_on:
      - postgres-db
      - rabbitmq
  
  hardware-control-service:
    #container_name: hardware-control-service
    build:
      context: ./services/hardware-control-service
      dockerfile: Dockerfile
    environment:
      - RABBITMQ_URL=${RABBITMQ_URL}
      - AI_API_URL=http://mock-ai-service:3004
    volumes:
      - ./services/hardware-control-service:/usr/src/app
      - /usr/src/app/node_modules
    deploy:
      restart_policy:
        condition: on-failure
    command: npm run dev
    networks:
      - scams-network
    depends_on:
      - rabbitmq
      - mock-ai-service

  # ---------------------------------------------------------------------------
  # INFRASTRUCTURE SERVICES
  # ---------------------------------------------------------------------------

  kong-gateway:
    image: kong:3.4
    container_name: kong-gateway
    environment:
      KONG_DATABASE: postgres
      KONG_PG_HOST: kong-db
      KONG_PG_USER: ${KONG_DB_USER}
      KONG_PG_PASSWORD: ${KONG_DB_PASSWORD}
      KONG_PG_DATABASE: ${KONG_DB_NAME}
      KONG_PLUGINS: bundled,jwt
      KONG_PROXY_LISTEN: 0.0.0.0:8000
      KONG_ADMIN_LISTEN: 0.0.0.0:8001
    command: /bin/sh -c "kong migrations bootstrap && kong start"
    ports:
      - "8000:8000"
      - "8001:8001"
    volumes:
      # Mount our config file for the gateway to use.
      - ./kong:/etc/kong
    restart: always
    networks:
      - scams-network
    # CRITICAL: This service must wait for the MIGRATION to complete successfully.
    depends_on:
      - kong-db

  kong-configurator:
    # MODIFIED: Instead of using a stock image, build our custom one.
    build:
      context: ./kong
      dockerfile: Dockerfile.configurator
    container_name: kong-configurator
    environment:
      KONG_LOG_LEVEL: debug
      KONG_DATABASE: postgres
      KONG_PG_HOST: kong-db
      KONG_PG_USER: ${KONG_DB_USER}
      KONG_PG_PASSWORD: ${KONG_DB_PASSWORD}
      KONG_PG_DATABASE: ${KONG_DB_NAME}
      KONG_DNS_RESOLVER: 127.0.0.11
      JWT_SECRET: ${JWT_SECRET}
    volumes:
      - ./kong:/etc/kong
    # MODIFIED: Use bash to run the script for better compatibility.
    command: /bin/bash /etc/kong/configure-kong.sh
    restart: on-failure
    networks:
      - scams-network
    depends_on:
      - kong-gateway

  kong-db:
    image: postgres:15-alpine
    container_name: kong-db
    environment:
      POSTGRES_USER: ${KONG_DB_USER}
      POSTGRES_PASSWORD: ${KONG_DB_PASSWORD}
      POSTGRES_DB: ${KONG_DB_NAME}
    volumes:
      - kong-data:/var/lib/postgresql/data
    restart: always
    networks:
      - scams-network
  
  postgres-db:
    image: postgres:15-alpine
    container_name: postgres-db
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./db-init:/docker-entrypoint-initdb.d
    restart: always
    networks:
      - scams-network
  
  rabbitmq:
    image: rabbitmq:3.11-management-alpine
    container_name: rabbitmq
    environment:
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_USER}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_PASS}
    ports:
      # The main AMQP port for services
      - "5672:5672"
      # The web management UI for debugging
      - "15672:15672"
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq/
    restart: always
    networks:
      - scams-network

  # ... (mock-roms-api service) ...
  mock-roms-api:
    container_name: mock-roms-api
    build:
      context: ./mocks/mock-roms-api
      dockerfile: Dockerfile
    ports:
      - "${ROMS_PORT}:3001"
    environment:
      - PORT=3001
    volumes:
      - ./mocks/mock-roms-api:/usr/src/app
      - /usr/src/app/node_modules
    command: npm run dev
    restart: always
    networks:
      - scams-network

  mock-ai-service:
    container_name: mock-ai-service
    build:
      context: ./mocks/mock-ai-service
      dockerfile: Dockerfile
    ports:
      - "${AI_PORT}:3004"
    environment:
      - PORT=3004
    volumes:
      - ./mocks/mock-ai-service:/usr/src/app
      - /usr/src/app/node_modules
    command: npm run dev
    restart: always
    networks:
      - scams-network

# -----------------------------------------------------------------------------
# VOLUMES & NETWORKS
# -----------------------------------------------------------------------------
volumes:
  postgres-data:
  kong-data:
  rabbitmq-data:

networks:
  scams-network:
    driver: bridge